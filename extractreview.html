<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Review CAR Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f5f5f5;
    }
    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 250px;
      background: #e0e0e0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .dropdown {
      margin-bottom: 1rem;
    }
    select {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
    }
    .sidebar button {
      background: none;
      border: none;
      padding: 0.5rem;
      margin-bottom: 0.25rem;
      text-align: left;
      cursor: pointer;
    }
    .sidebar button.active {
      background: #007acc;
      color: white;
    }
    .sidebar button.submit-btn {
      margin-top: auto;
      background: #28a745;
      color: white;
    }
    .sidebar button.delete-btn {
      background: #dc3545;
      color: white;
    }
    .content {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      background: white;
    }
    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 14px;
    }
    th {
      background-color: #071d49;
      color: white;
      padding: 10px 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    td {
      padding: 0;
      border: 1px solid #ddd;
      vertical-align: top;
    }
    input, textarea {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border: none;
      background-color: transparent;
      box-sizing: border-box;
    }
    input:focus, textarea:focus {
      outline: none;
      background-color: #eef2ff;
    }
    textarea {
      resize: none;
      min-height: 60px;
      white-space: pre-wrap;
    }
    .status {
      margin-top: 1rem;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="dropdown">
        <select id="carSelector" onchange="changeCar()"></select>
      </div>
      <div id="sectionButtons"></div>
      <button class="submit-btn" onclick="submitCar()">‚úÖ Submit</button>
      <button class="delete-btn" onclick="deleteCar()">üóëÔ∏è Delete</button>
      <p id="status" class="status"></p>
    </div>
    <div class="content">
      <h3 id="sectionTitle">Loading...</h3>
      <div id="tableContainer"></div>
    </div>
  </div>

  <script>
    const sectionLabels = {
      Section_A: "General Info",
      Section_B1: "Chronology",
      Section_B2: "Cost Impact",
      Section_C: "Root Cause (5Why)",
      Section_D: "Correction Taken",
      Section_E1: "Corrective Action",
      Section_E2: "Conclusion Review"
    };

    let carDataMulti = JSON.parse(localStorage.getItem("car_data_multi") || "[]");
    let selectedCarId = localStorage.getItem("car_id") || "";
    let currentData = {};
    let currentSection = "Section_C";

    function loadDropdown() {
      const dropdown = document.getElementById("carSelector");
      dropdown.innerHTML = "";
      carDataMulti.forEach(item => {
        const option = document.createElement("option");
        option.value = item.car_id;
        option.textContent = item.car_id;
        if (item.car_id === selectedCarId) option.selected = true;
        dropdown.appendChild(option);
      });
    }

    function changeCar() {
      selectedCarId = document.getElementById("carSelector").value;
      localStorage.setItem("car_id", selectedCarId);
      const found = carDataMulti.find(c => c.car_id === selectedCarId);
      if (found) {
        currentData = found.data;
        localStorage.setItem("car_data", JSON.stringify(currentData));
        loadSectionButtons();
        renderSection(currentSection);
      }
    }

    function loadSectionButtons() {
      const sectionBtnWrap = document.getElementById("sectionButtons");
      sectionBtnWrap.innerHTML = "";
      for (const key in sectionLabels) {
        const btn = document.createElement("button");
        btn.textContent = sectionLabels[key];
        btn.className = (key === currentSection ? "active" : "");
        btn.onclick = () => {
          currentSection = key;
          renderSection(currentSection);
          loadSectionButtons();
        };
        sectionBtnWrap.appendChild(btn);
      }
    }

    function renderSection(section) {
      document.getElementById("sectionTitle").textContent = sectionLabels[section];
      const container = document.getElementById("tableContainer");
      const rows = currentData[section];
      if (!rows || rows.length === 0) {
        container.innerHTML = `<p>No data found for ${section}.</p>`;
        return;
      }

      const headers = Object.keys(rows[0]);
      let html = `<table><thead><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead><tbody>`;

      rows.forEach((row, rowIdx) => {
        html += `<tr>`;
        headers.forEach(h => {
          html += `<td><input value="${row[h] || ""}" onchange="updateField('${section}', ${rowIdx}, '${h}', this.value)"></td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function updateField(section, rowIdx, field, value) {
      currentData[section][rowIdx][field] = value;
      const carIdx = carDataMulti.findIndex(c => c.car_id === selectedCarId);
      if (carIdx !== -1) carDataMulti[carIdx].data = currentData;
      localStorage.setItem("car_data_multi", JSON.stringify(carDataMulti));
      localStorage.setItem("car_data", JSON.stringify(currentData));
    }

    async function submitCar() {
      document.getElementById("status").textContent = "Submitting...";
      try {
        const res = await fetch("https://capstone-backend-128c.onrender.com/submit-car", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ car_id: selectedCarId, data: currentData })
        });
        const result = await res.json();
        if (result.status) {
          document.getElementById("status").textContent = "‚úÖ Submitted!";
        } else {
          document.getElementById("status").textContent = result.error || "‚ùå Submission failed.";
        }
      } catch (err) {
        document.getElementById("status").textContent = "‚ùå " + err.message;
      }
    }

    function deleteCar() {
      if (!confirm(`Are you sure you want to delete ${selectedCarId}?`)) return;
      carDataMulti = carDataMulti.filter(c => c.car_id !== selectedCarId);
      if (carDataMulti.length > 0) {
        selectedCarId = carDataMulti[0].car_id;
        currentData = carDataMulti[0].data;
        localStorage.setItem("car_data_multi", JSON.stringify(carDataMulti));
        localStorage.setItem("car_id", selectedCarId);
        localStorage.setItem("car_data", JSON.stringify(currentData));
      } else {
        localStorage.removeItem("car_data_multi");
        localStorage.removeItem("car_id");
        localStorage.removeItem("car_data");
      }
      loadDropdown();
      loadSectionButtons();
      renderSection(currentSection);
    }

    // Init
    window.onload = () => {
      const found = carDataMulti.find(c => c.car_id === selectedCarId);
      if (found) currentData = found.data;
      loadDropdown();
      loadSectionButtons();
      renderSection(currentSection);
    };
  </script>
</body>
</html>

