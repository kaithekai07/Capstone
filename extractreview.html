<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Review Extracted CAR Data</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="ExtractReview.css" />
  </head>
  <body>
    <div id="root"></div>

    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Inline React Component -->
    <script type="text/babel">

      function ExtractReview() {
        const [data, setData] = React.useState({});
        const [section, setSection] = React.useState("Section_A");
        const [status, setStatus] = React.useState("");
        const [loading, setLoading] = React.useState(false);

        React.useEffect(() => {
          const raw = localStorage.getItem("car_data");
          if (raw) setData(JSON.parse(raw));
        }, []);

        const handleChange = (sec, idx, key, val) => {
          const updated = { ...data };
          updated[sec][idx][key] = val;
          setData(updated);
        };

        const handleSubmit = async () => {
          setLoading(true);
          setStatus("Submitting...");
          try {
            const res = await fetch("https://capstone-backend-128c.onrender.com/submit", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data)
            });
            const result = await res.json();
            setStatus(result.result || result.error || "Submitted.");
          } catch (err) {
            setStatus("❌ " + err.message);
          } finally {
            setLoading(false);
          }
        };

        const sectionLabels = {
          Section_A: "General Info",
          Section_B1: "Chronology",
          Section_B2: "Cost Impact",
          Section_C: "Root Cause (5Why)",
          Section_D: "Correction Taken",
          Section_E1: "Corrective Action",
          Section_E2: "Conclusion Review"
        };

        return (
          <div className="review-container">
            <aside className="sidebar">
              {Object.keys(sectionLabels).map((key) => (
                <button
                  key={key}
                  className={section === key ? "active" : ""}
                  onClick={() => setSection(key)}
                >
                  {sectionLabels[key]}
                </button>
              ))}
              <button className="submit-btn" onClick={handleSubmit} disabled={loading}>
                ✅ Submit to Supabase
              </button>
              {loading && <p>Submitting...</p>}
              {status && <p>{status}</p>}
            </aside>

            <main className="section-content">
              <h2>{sectionLabels[section]}</h2>
              {data[section]?.map((record, i) => (
                <div key={i} className="record-box">
                  {Object.entries(record).map(([key, val]) => (
                    <div key={key} className="input-group">
                      <label>{key}</label>
                      <input
                        value={val}
                        onChange={(e) => handleChange(section, i, key, e.target.value)}
                      />
                    </div>
                  ))}
                </div>
              ))}
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<ExtractReview />);
    </script>
  </body>
</html>
