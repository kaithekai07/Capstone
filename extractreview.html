<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Review CAR Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f5f5f5;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 220px;
      background: #e0e0e0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }

    .sidebar select {
      margin-bottom: 1rem;
      padding: 0.5rem;
      font-size: 1rem;
    }

    .sidebar button {
      margin-top: 0.5rem;
      padding: 0.6rem;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      font-size: 0.9rem;
    }

    .submit-btn {
      background-color: #2563eb;
      color: white;
    }

    .delete-btn {
      background-color: #dc2626;
      color: white;
    }

    .content {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      background: white;
    }

    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 14px;
    }

    th {
      background-color: #071d49;
      color: white;
      padding: 10px 8px;
      text-align: left;
      border: 1px solid #ddd;
    }

    td {
      border: 1px solid #ddd;
      padding: 0;
    }

    input, textarea {
      width: 100%;
      padding: 8px;
      border: none;
      font-size: 14px;
      background-color: transparent;
      box-sizing: border-box;
    }

    input:focus, textarea:focus {
      outline: none;
      background-color: #eef2ff;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .section-btn {
      background: none;
      border: none;
      text-align: left;
      padding: 0.5rem;
      cursor: pointer;
    }

    .section-btn.active {
      font-weight: bold;
      color: #2563eb;
    }

    .status {
      margin-top: 1rem;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    function ExtractReview() {
      const [multiData, setMultiData] = React.useState([]);
      const [selectedCarId, setSelectedCarId] = React.useState("");
      const [data, setData] = React.useState({});
      const [section, setSection] = React.useState("Section_C");
      const [status, setStatus] = React.useState("");
      const [loading, setLoading] = React.useState(false);

      React.useEffect(() => {
        const rawMulti = localStorage.getItem("car_data_multi");

        if (!rawMulti) {
          alert("‚ùå No CAR data found. Please upload at least one CAR.");
          window.location.href = "upload.html";
          return;
        }

        const parsed = JSON.parse(rawMulti);
        setMultiData(parsed);

        // Load first one by default
        const first = parsed[0];
        setSelectedCarId(first.car_id);
        setData(first.data);
        localStorage.setItem("car_id", first.car_id);
        localStorage.setItem("car_data", JSON.stringify(first.data));
      }, []);

      const handleCarChange = (e) => {
        const id = e.target.value;
        setSelectedCarId(id);
        const found = multiData.find(car => car.car_id === id);
        if (found) {
          setData(found.data);
          localStorage.setItem("car_id", found.car_id);
          localStorage.setItem("car_data", JSON.stringify(found.data));
        }
      };

      const handleChange = (sec, idx, key, val) => {
        const updated = { ...data };
        updated[sec][idx][key] = val;
        setData(updated);

        const newMulti = multiData.map(car => {
          if (car.car_id === selectedCarId) {
            return { ...car, data: updated };
          }
          return car;
        });
        setMultiData(newMulti);
        localStorage.setItem("car_data_multi", JSON.stringify(newMulti));
        localStorage.setItem("car_data", JSON.stringify(updated));
      };

      const handleSubmit = async () => {
        setLoading(true);
        setStatus("Submitting...");
        try {
          const res = await fetch("https://capstone-backend-128c.onrender.com/submit-car", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ car_id: selectedCarId, data })
          });
          const result = await res.json();
          if (result.status?.includes("‚úÖ")) {
            setStatus("‚úÖ Submission complete!");
            localStorage.removeItem("car_data");
            localStorage.removeItem("car_id");
            const remaining = multiData.filter(car => car.car_id !== selectedCarId);
            if (remaining.length === 0) {
              localStorage.removeItem("car_data_multi");
              window.location.href = "thankyou.html";
            } else {
              localStorage.setItem("car_data_multi", JSON.stringify(remaining));
              setMultiData(remaining);
              setSelectedCarId(remaining[0].car_id);
              setData(remaining[0].data);
            }
          } else {
            setStatus(result.error || "Submission failed.");
          }
        } catch (err) {
          setStatus("‚ùå " + err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleDelete = () => {
        const filtered = multiData.filter(car => car.car_id !== selectedCarId);
        if (filtered.length === 0) {
          localStorage.removeItem("car_data_multi");
          localStorage.removeItem("car_data");
          localStorage.removeItem("car_id");
          window.location.href = "upload.html";
        } else {
          setMultiData(filtered);
          setSelectedCarId(filtered[0].car_id);
          setData(filtered[0].data);
          localStorage.setItem("car_data_multi", JSON.stringify(filtered));
          localStorage.setItem("car_id", filtered[0].car_id);
          localStorage.setItem("car_data", JSON.stringify(filtered[0].data));
        }
      };

      const sectionLabels = {
        Section_A: "General Info",
        Section_B1: "Chronology",
        Section_B2: "Cost Impact",
        Section_C: "Root Cause (5Why)",
        Section_D: "Correction Taken",
        Section_E1: "Corrective Action",
        Section_E2: "Conclusion Review"
      };

      return (
        <div className="container">
          <div className="sidebar">
            <select value={selectedCarId} onChange={handleCarChange}>
              {multiData.map((car) => (
                <option key={car.car_id} value={car.car_id}>
                  {car.car_id}
                </option>
              ))}
            </select>

            {Object.entries(sectionLabels).map(([sec, label]) => (
              <button
                key={sec}
                className={`section-btn ${section === sec ? "active" : ""}`}
                onClick={() => setSection(sec)}
              >
                {label}
              </button>
            ))}

            <button className="submit-btn" onClick={handleSubmit} disabled={loading}>
              ‚úÖ Submit
            </button>
            <button className="delete-btn" onClick={handleDelete}>
              üóëÔ∏è Delete
            </button>

            {status && <p className="status">{status}</p>}
          </div>

          <div className="content">
            <h3>{sectionLabels[section]}</h3>
            {data[section]?.length > 0 ? (
              <table>
                <thead>
                  <tr>
                    {Object.keys(data[section][0]).map((field) => (
                      <th key={field}>{field}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {data[section].map((record, rowIdx) => (
                    <tr key={rowIdx}>
                      {Object.entries(record).map(([key, val]) => (
                        <td key={key}>
                          {key === "ANSWER" ? (
                            <textarea
                              value={val}
                              onChange={(e) =>
                                handleChange(section, rowIdx, key, e.target.value)
                              }
                            />
                          ) : (
                            <input
                              value={val}
                              onChange={(e) =>
                                handleChange(section, rowIdx, key, e.target.value)
                              }
                            />
                          )}
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            ) : (
              <p>No data found for this section.</p>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<ExtractReview />);
  </script>
</body>
</html>
