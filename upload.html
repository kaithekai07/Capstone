<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload CARs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="referrer" content="no-referrer">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f7fa;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      margin-bottom: 1rem;
    }

    .upload-box {
      border: 2px dashed #ccc;
      padding: 2rem;
      border-radius: 10px;
      background-color: #fff;
      text-align: center;
      width: 100%;
      max-width: 500px;
      cursor: pointer;
    }

    .upload-box:hover {
      border-color: #2563eb;
    }

    .upload-box input {
      display: none;
    }

    .upload-label {
      font-size: 1.2rem;
      color: #333;
    }

    .file-list {
      margin-top: 1.5rem;
      width: 100%;
      max-width: 500px;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .file-name {
      flex: 1;
      margin-right: 1rem;
      overflow-wrap: anywhere;
    }

    .delete-btn {
      background-color: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }

    .submit-btn {
      margin-top: 1.5rem;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
    }

    .home-btn {
      margin-top: 1rem;
      background-color: #10b981;
      color: white;
      text-decoration: none;
      padding: 0.75rem 1.5rem;
      border-radius: 5px;
      display: inline-block;
    }

    .status {
      margin-top: 1rem;
      font-size: 14px;
      color: #555;
    }

    @media (max-width: 600px) {
      .upload-box,
      .file-list {
        max-width: 95%;
      }
    }
  </style>
</head>
<body>
  <h2>Upload CAR PDFs</h2>

  <label class="upload-box" id="uploadBox">
    <span class="upload-label">üìÑ Click or Drop PDF Files Here</span>
    <input type="file" id="fileInput" multiple accept=".pdf" />
  </label>

  <div class="file-list" id="fileListContainer"></div>

  <button class="submit-btn" onclick="submitFiles()">üì§ Submit All</button>
  <a href="safesightai.html" class="home-btn">üè† Back to Home</a>

  <script>
    const fileInput = document.getElementById("fileInput");
    const fileListContainer = document.getElementById("fileListContainer");
    let selectedFiles = [];

    fileInput.addEventListener("change", () => {
      handleFiles(fileInput.files);
      fileInput.value = ""; // clear so you can reselect same file
    });

    document.getElementById("uploadBox").addEventListener("dragover", (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.target.classList.add("dragover");
    });

    document.getElementById("uploadBox").addEventListener("drop", (e) => {
      e.preventDefault();
      e.stopPropagation();
      handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
      for (const file of files) {
        if (file.type !== "application/pdf") continue;
        if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
          selectedFiles.push(file);
        }
      }
      renderFileList();
    }

    function renderFileList() {
      fileListContainer.innerHTML = "";
      selectedFiles.forEach((file, index) => {
        const item = document.createElement("div");
        item.className = "file-item";

        const name = document.createElement("div");
        name.className = "file-name";
        name.textContent = file.name;

        const del = document.createElement("button");
        del.className = "delete-btn";
        del.textContent = "Delete";
        del.onclick = () => {
          selectedFiles.splice(index, 1);
          renderFileList();
        };

        item.appendChild(name);
        item.appendChild(del);
        fileListContainer.appendChild(item);
      });
    }

    async function submitFiles() {
      if (selectedFiles.length === 0) {
        alert("Please select at least one file.");
        return;
      }

      for (const file of selectedFiles) {
        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("https://capstone-backend-128c.onrender.com/analyze", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();
          if (!result?.results?.[0]?.car_id) {
            throw new Error("Upload failed or missing car_id");
          }

          // Save result
          const uploaded = result.results[0];
          const existing = JSON.parse(localStorage.getItem("car_data_multi") || "[]");
          const updated = [...existing, uploaded];
          localStorage.setItem("car_data_multi", JSON.stringify(updated));
          localStorage.setItem("car_id", uploaded.car_id);
          localStorage.setItem("car_data", JSON.stringify(uploaded.data));
        } catch (error) {
          console.error("‚ùå Upload failed for", file.name, error);
          alert(`‚ùå Upload failed for ${file.name}`);
        }
      }

      alert("‚úÖ All files uploaded!");
      window.location.href = "extractreview.html";
    }

    // Optional: auto-open file picker
    document.getElementById("uploadBox").addEventListener("click", () => {
      fileInput.click();
    });
  </script>
</body>
</html>




